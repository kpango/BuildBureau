#
# Copyright (C) 2024-2026 BuildBureau team
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: "Check Merge Conflicts"
on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to check"
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

jobs:
  check-conflict:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Check for merge conflicts
        id: check
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # Get the base branch
          BASE_BRANCH="${{ github.event.pull_request.base.ref || github.base_ref || 'main' }}"
          HEAD_BRANCH="${{ github.event.pull_request.head.ref || github.head_ref }}"
          
          echo "Base branch: ${BASE_BRANCH}"
          echo "Head branch: ${HEAD_BRANCH}"
          
          # Fetch the base branch
          git fetch origin "${BASE_BRANCH}"
          
          # Try to merge
          if git merge --no-commit --no-ff "origin/${BASE_BRANCH}"; then
            echo "has_conflict=false" >> $GITHUB_OUTPUT
            echo "No merge conflicts detected"
            git merge --abort 2>/dev/null || true
          else
            echo "has_conflict=true" >> $GITHUB_OUTPUT
            echo "Merge conflicts detected!"
            
            # Get list of conflicting files
            CONFLICTS=$(git diff --name-only --diff-filter=U || echo "")
            echo "conflicts<<EOF" >> $GITHUB_OUTPUT
            echo "${CONFLICTS}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            git merge --abort 2>/dev/null || true
          fi

      - name: Comment on PR if conflicts found
        if: steps.check.outputs.has_conflict == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const conflicts = `${{ steps.check.outputs.conflicts }}`;
            const conflictList = conflicts.split('\n').filter(f => f).map(f => `- \`${f}\``).join('\n');
            
            const body = `## ⚠️ Merge Conflicts Detected
            
            This PR has merge conflicts with the base branch that need to be resolved.
            
            ### Conflicting files:
            ${conflictList}
            
            Please resolve these conflicts and push the changes.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Add conflict label
        if: steps.check.outputs.has_conflict == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['merge-conflict']
            });

      - name: Remove conflict label if resolved
        if: steps.check.outputs.has_conflict == 'false' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            github.rest.issues.removeLabel({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'merge-conflict'
            });
