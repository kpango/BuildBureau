#
# Copyright (C) 2024-2026 BuildBureau team
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: "Notify on Workflow Failure"
on:
  workflow_run:
    workflows: ["*"]
    types:
      - completed

permissions:
  contents: read
  actions: read

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get workflow information
        id: info
        run: |
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "workflow_url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
          echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          echo "actor=${{ github.event.workflow_run.actor.login }}" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: ./.github/actions/notify-slack
        with:
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: failure
          workflow_name: ${{ steps.info.outputs.workflow_name }}
          message: |
            Workflow '${{ steps.info.outputs.workflow_name }}' failed on branch '${{ steps.info.outputs.branch }}'
            
            Triggered by: @${{ steps.info.outputs.actor }}
            Run ID: ${{ steps.info.outputs.run_id }}

      - name: Create issue on repeated failure
        if: github.event.workflow_run.run_attempt > 1
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = '${{ steps.info.outputs.workflow_name }}';
            const branch = '${{ steps.info.outputs.branch }}';
            const runUrl = '${{ steps.info.outputs.workflow_url }}';
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes(workflowName) && issue.title.includes(branch)
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `CI Failure: ${workflowName} on ${branch}`,
                body: `## ‚ùå CI Workflow Failure
                
                The workflow **${workflowName}** has failed multiple times on branch \`${branch}\`.
                
                **Workflow Run:** ${runUrl}
                **Triggered by:** @${{ steps.info.outputs.actor }}
                **Attempt:** ${{ github.event.workflow_run.run_attempt }}
                
                Please investigate and fix the issue.`,
                labels: ['ci-failure', 'bug', 'priority/high']
              });
            }
