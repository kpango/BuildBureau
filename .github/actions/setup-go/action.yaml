#
# Copyright (C) 2024-2026 BuildBureau team
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: "Setup Go environment"
description: "An action to set up Go environment with caching and version detection"
inputs:
  go_version:
    description: "The Go version to use. If not specified, uses version from go.mod"
    required: false
    default: ""
  cache:
    description: "Enable Go module caching"
    required: false
    default: "true"
runs:
  using: "composite"
  steps:
    - name: Fetch Go version
      id: go_version
      shell: bash
      run: |
        if [ -n "${{ inputs.go_version }}" ]; then
          GO_VERSION="${{ inputs.go_version }}"
        else
          # Extract version from go.mod
          if [ -f "go.mod" ]; then
            GO_VERSION=$(grep -E "^go [0-9]+\.[0-9]+(\.[0-9]+)?" go.mod | awk '{print $2}')
          else
            GO_VERSION="1.26.0"
          fi
        fi
        echo "version=${GO_VERSION}" >> $GITHUB_OUTPUT
        echo "Using Go version: ${GO_VERSION}"

    - name: Check if Go is installed
      id: check_go
      shell: bash
      run: |
        if command -v go &> /dev/null; then
          INSTALLED_VERSION=$(go version | awk '{print $3}' | sed 's/go//')
          echo "go_installed=true" >> $GITHUB_OUTPUT
          echo "installed_version=${INSTALLED_VERSION}" >> $GITHUB_OUTPUT
          echo "Go is installed: ${INSTALLED_VERSION}"
        else
          echo "go_installed=false" >> $GITHUB_OUTPUT
          echo "Go is not installed"
        fi

    - name: Setup Go
      if: steps.check_go.outputs.go_installed == 'false' || steps.check_go.outputs.installed_version != steps.go_version.outputs.version
      uses: actions/setup-go@v5
      with:
        go-version: ${{ steps.go_version.outputs.version }}
        cache: ${{ inputs.cache }}

    - name: Verify Go version
      shell: bash
      run: |
        go version
        echo "GOPATH: $GOPATH"
        echo "GOROOT: $(go env GOROOT)"
