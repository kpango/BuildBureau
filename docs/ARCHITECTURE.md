# BuildBureau Architecture Documentation

## システムアーキテクチャ

BuildBureauは階層型マルチエージェントシステムで、企業組織の構造を模倣した設計になっています。

### 階層構造

```
┌─────────────────────────────────────────────┐
│           クライアント (利用者)              │
└────────────────┬────────────────────────────┘
                 │
┌────────────────▼────────────────────────────┐
│          社長エージェント                   │
│        + 社長秘書エージェント               │
│  (全体計画立案・要件整理)                  │
└────────────────┬────────────────────────────┘
                 │
┌────────────────▼────────────────────────────┐
│         部長エージェント                    │
│        + 部長秘書エージェント               │
│  (タスク分割・課長への割り当て)            │
└────────────────┬────────────────────────────┘
                 │
┌────────────────▼────────────────────────────┐
│        課長エージェント × N                │
│       + 課長秘書エージェント × N            │
│  (実装計画策定・平社員への指示)            │
└────────────────┬────────────────────────────┘
                 │
┌────────────────▼────────────────────────────┐
│        平社員エージェント × M              │
│  (実際の実装・成果物作成)                  │
└─────────────────────────────────────────────┘
```

## コンポーネント詳細

### 1. エージェント層

#### 社長エージェント (President Agent)
- **役割**: プロジェクト全体の計画立案と要件整理
- **入力**: クライアントからの要件仕様
- **出力**: タスクリスト（部長層への指示）
- **機能**:
  - 要件の分析と理解
  - プロジェクト全体計画の策定
  - タスクの優先順位付け
  - 全体進捗の監視

#### 社長秘書エージェント (President Secretary Agent)
- **役割**: 社長のサポートと要件詳細化
- **機能**:
  - 要件のドキュメント化
  - ナレッジベースの更新
  - タスクの詳細化
  - 部長秘書への引き継ぎ

#### 部長エージェント (Department Manager Agent)
- **役割**: タスクを課長単位に分割
- **入力**: 社長からのタスクリスト
- **出力**: セクションタスクプラン
- **機能**:
  - タスクの技術的分析
  - 課長への適切な割り当て
  - 課題の調整と優先順位付け

#### 部長秘書エージェント (Department Secretary Agent)
- **役割**: タスクの詳細化とリサーチ
- **機能**:
  - タスクの技術調査
  - 関連情報の収集
  - 課長秘書との調整

#### 課長エージェント (Section Manager Agent) × N
- **役割**: 実装計画と仕様書の策定
- **入力**: セクションタスク
- **出力**: 実装仕様書
- **機能**:
  - 詳細な実装計画の作成
  - 平社員への作業割り当て
  - 実装結果のレビュー

#### 課長秘書エージェント (Section Secretary Agent) × N
- **役割**: 実装手順のドラフト作成
- **機能**:
  - 仕様の詰め
  - 他課長秘書との調整
  - 実装手順書の作成

#### 平社員エージェント (Employee Agent) × M
- **役割**: 実際の実装作業
- **入力**: 実装仕様書
- **出力**: 成果物（コード、ドキュメント等）
- **機能**:
  - コーディング
  - ドキュメント作成
  - テスト実行

### 2. 通信層 (gRPC)

#### Protocol Buffers定義

すべてのサービスは`proto/buildbureau/v1/service.proto`で定義されています。

主要なメッセージ型:
- `RequirementSpec`: プロジェクト要件
- `TaskUnit`: 個別タスク
- `TaskList`: タスクのリスト
- `SectionTask`: セクションごとのタスク
- `ImplementationSpec`: 実装仕様
- `ResultArtifact`: 実行結果

主要なサービス:
- `PresidentService`: プロジェクト計画
- `DepartmentManagerService`: タスク分割
- `SectionManagerService`: 実装計画
- `EmployeeService`: タスク実行

### 3. 設定管理層

#### YAML設定ファイル (config.yaml)

全ての設定は単一のYAMLファイルで管理されます：

```yaml
agents:          # エージェント設定
llm:            # LLMプロバイダー設定
grpc:           # gRPC通信設定
slack:          # Slack通知設定
ui:             # ターミナルUI設定
system:         # システム全般設定
```

#### 環境変数

機密情報は環境変数で管理:
- `SLACK_BOT_TOKEN`: Slack Botトークン
- `SLACK_CHANNEL_ID`: 通知先チャンネルID
- `GOOGLE_AI_API_KEY`: Google AI APIキー

### 4. UI層 (Bubble Tea)

#### Terminal UI コンポーネント

- **入力エリア**: プロジェクト要件の入力
- **ステータス表示**: 各エージェントの状態
- **メッセージログ**: システムメッセージの表示
- **プログレス表示**: 進行状況の可視化

#### キー操作

- `Alt+Enter`: 要件送信
- `Esc`: 終了

### 5. 通知層 (Slack)

#### イベント種別

1. **プロジェクト開始** (`project_start`)
   - プロジェクトが開始されたとき

2. **タスク完了** (`task_complete`)
   - 各タスクが完了したとき

3. **エラー発生** (`error`)
   - エラーが発生したとき

4. **プロジェクト完了** (`project_complete`)
   - プロジェクト全体が完了したとき

#### メッセージテンプレート

テンプレート内で以下の変数が使用可能:
- `{{.ProjectName}}`: プロジェクト名
- `{{.TaskName}}`: タスク名
- `{{.Agent}}`: エージェントID
- `{{.ErrorMessage}}`: エラーメッセージ
- `{{.Timestamp}}`: タイムスタンプ

## データフロー

### 1. プロジェクト開始フロー

```
クライアント
  ↓ (要件入力)
社長エージェント
  ↓ (要件分析)
社長秘書エージェント
  ↓ (要件詳細化)
部長秘書エージェント
  ↓ (リサーチ・調整)
部長エージェント
  ↓ (タスク分割)
課長秘書エージェント × N
  ↓ (仕様詰め)
課長エージェント × N
  ↓ (実装計画)
平社員エージェント × M
  ↓ (実装)
成果物
```

### 2. 結果集約フロー

```
平社員エージェント
  ↓ (成果物)
課長エージェント
  ↓ (レビュー・集約)
部長エージェント
  ↓ (統合)
社長エージェント
  ↓ (最終確認)
クライアント
```

## 拡張性

### スケーラビリティ

- **水平スケーリング**: 各エージェント数はYAMLで設定可能
- **分散実行**: gRPCインターフェースにより独立プロセス化が可能
- **マイクロサービス化**: 将来的に各層を別サービスとして分離可能

### カスタマイズ

- **エージェント人格**: YAMLでプロンプトをカスタマイズ
- **ツール追加**: 各エージェントに使用可能なツールを設定
- **通知カスタマイズ**: Slackメッセージテンプレートの変更

## セキュリティ

### 機密情報の管理

- 環境変数による機密情報の分離
- `.env`ファイルの`.gitignore`への追加
- APIキーの定期的なローテーション推奨

### 通信セキュリティ

- gRPC over TLS対応（設定により有効化）
- 認証・認可機能の追加予定

## パフォーマンス

### 並行処理

- Goのgoroutineによる効率的な並行処理
- エージェント間の非同期通信
- タスクの並列実行（設定で制限可能）

### リソース管理

- タイムアウト設定による無限待機の防止
- リトライ回数の制限
- 同時実行タスク数の上限設定

## トラブルシューティング

### よくある問題

1. **ビルドエラー**: `make deps`で依存関係を再インストール
2. **Slack通知が届かない**: トークンとチャンネルIDを確認
3. **エージェントがタイムアウト**: `config.yaml`のタイムアウト値を増加

### ログ確認

```bash
# ログディレクトリ
./logs/

# ログレベル設定
ui.logLevel: "debug"  # config.yaml内
```

## 今後の開発予定

1. **Google ADK統合**: 実際のLLM呼び出しの実装
2. **ナレッジベース**: エージェント間で共有される知識ベースシステム
3. **ツールシステム**: エージェントが使用できる外部ツールの実装
4. **Webインターフェース**: ブラウザベースのUIの追加
5. **メトリクス**: プロメテウス対応のメトリクス収集
6. **A2Aプロトコル**: Agent-to-Agent通信の実装
