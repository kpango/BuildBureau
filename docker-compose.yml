version: "3.8"

services:
  buildbureau:
    build:
      context: .
      dockerfile: Dockerfile
    image: buildbureau:latest
    container_name: buildbureau
    restart: unless-stopped

    # Environment variables for LLM API keys
    environment:
      # Required: At least one LLM provider API key
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - CLAUDE_API_KEY=${CLAUDE_API_KEY:-}

      # Optional: Model overrides
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4-turbo-preview}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-3-5-sonnet-20241022}

      # Optional: Slack integration
      - SLACK_TOKEN=${SLACK_TOKEN:-}

      # Optional: Vald configuration
      - VALD_HOST=${VALD_HOST:-vald}
      - VALD_PORT=${VALD_PORT:-8081}

    # Volumes for persistent data
    volumes:
      - buildbureau-data:/app/data
      - ./config.yaml:/app/config/config.yaml:ro
      - ./agents:/app/agents:ro

    # Ports
    ports:
      - "8080:8080" # gRPC server

    # Dependencies
    depends_on:
      - vald

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "1"
          memory: 512M

    # Health check
    healthcheck:
      test: ["CMD", "/app/buildbureau", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Optional: Vald vector database for semantic search
  vald:
    image: vdaas/vald:latest
    container_name: buildbureau-vald
    restart: unless-stopped
    profiles:
      - with-vald # Only start when using --profile with-vald

    ports:
      - "8081:8081" # gRPC port
      - "8082:8082" # REST API port

    volumes:
      - vald-data:/var/vald

    environment:
      - VALD_DIMENSION=768
      - VALD_AGENT_NAMESPACE=buildbureau

    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 256M

volumes:
  buildbureau-data:
    driver: local
  vald-data:
    driver: local
